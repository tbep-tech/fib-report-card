---
title: "Enterococcus functions in tbeptools"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Enterococcus}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = F, warning = F, 
  fig.align = 'center', 
  cache = F
)

# libraries
library(tbeptools)
library(dplyr)
```

## Background  

Some text here about Enterococcus, why it's a useful indicator, what the hopes are (system-wide report card)  

## Read  

The main function for importing Enterococcus data is `read_importentero()`. Talk about the options. Talk about how it pulls data from the water quality portal.  

First, you need to set up a list of arguments, which will be fed into the WQP API. You can do so as follows:  

```{r, eval = F}
# set up arguments
stations <- c('21FLHILL_WQX-101',
              '21FLHILL_WQX-102',
              '21FLHILL_WQX-103')
entero_names <- c('Enterococci',
                  'Enterococcus')
startDate <- as.Date('2023-01-01')
endDate <- as.Date('2023-02-01')

# put the arguments into a list
args <- list(
  siteid = stations,
  characteristicName = entero_names,
  startDateLo = format(startDate, '%m-%d-%Y'),
  startDateHi = format(endDate, '%m-%d-%Y')
)

# download and read the data
entero_in <- read_importentero(args = args)

# investigate
head(entero_in)
```

A data object is also provided with the package: `enterodata` includes all data from 53 selected stations, from 1995-2023.  

```{r}
head(enterodata, 10)
```


## Analyze  

### `anlz_enteromap()`  

The `anlz_enteromap()` function is an Enterococcus-specific analogue to the `anlz_fibmap()` fecal coliform function. It assigns categories to each observation in an input data frame, which can be viewed for a given month and year using `show_enteromap()` (analagous to `show_fibmap()`). The categories are specific to Enterococcus in marine waters, and are noted in the `cat` column of the output. Corresponding colors are in the `col` column of the output.  

```{r}
anlz_enteromap(enterodata) %>% 
    head(10)
```


The thresholds are from the Environmental Protection Commission of Hillsborough County and are as follows for Enterococcus:  

```{r, echo = F}
fibdata %>%
    anlz_fibmap() %>% 
    select(Indicator = ind, Threshold = cat) %>% 
    filter(Indicator == "Enterococcus") %>%
    unique() %>% 
    na.omit() %>% 
    arrange(Indicator) %>% 
    knitr::kable()
```

The `yrsel` and `mosel` arguments can be used to filter results by year and month.  Not specifying these arguments will return results for the entire period of record. 

```{r}
anlz_enteromap(enterodata, yrsel = 2020, mosel = 8)
```

The `wetdry` argument can be used to determine whether a sample was taken after a rain event (logical `wet_sample` column in output), based on user-specified thresholds and a provided precipitation data object. 

**TALK MORE ABOUT THIS MAYBE** - precipdata only exists for our 53 stations, and it's radar-estimated data for the entire watershed, etc.  

In the below example, we specify 0.5 inches of rain over 2 days (the sample day plus one day before) as a threshold for a rain event.  

```{r}
anlz_enteromap(enterodata, wetdry = TRUE,
               precipdata = catchprecip,
               temporal_window = 2,
               wet_threshold = 0.5) %>%
    head(10)
```


### `anlz_fibmatrix()`  
  
`anlz_fibmatrix()` - discuss wet/dry subsetting option but how it's sort of squirrely  


### `anlz_fibwetdry()`  

The function `anlz_fibwetdry()` is used for the wet/dry subsetting of the `anlz_enteromap()` and `anlz_fibmatrix()` functions, but can also be used on its own, e.g. to calculate how many samples in a given year were 'wet'. A data frame with daily rainfall amounts must be supplied - the `catchprecip` object in `tbeptools` contains this for the catchments of 53 select stations. The user may also provide thresholds for amount of rain and a temporal window (1 = day of sample only; 2 = day of sample + day before; etc.) via the `wet_threshold` and `temporal_window` arguments, respectively. The arguments default to 0.5 inches over 2 days.  

The function returns the original data frame with three additional columns: `rain_sampleDay`, for the amount of precipitation on the sample day; `rain_total`, the amount of precipitation day over the given `temporal_window`, and `wet_sample`, a logical column for whether the `rain_total` exceeded the `wet_threshold`, resulting in the sample being considered "wet".  

```{r}
anlz_fibwetdry(enterodata, 
               precipdata = catchprecip,
               temporal_window = 3,
               wet_threshold = 0.5) %>%
    head(10)
```




## Show  

The `show_enteromap()` function creates a map of Enterococcus sites and thresholds based on output from `anlz_enteromap()`. The same arguments that apply to `anlz_enteromap()` also apply to `show_enteromap()`, including classification of samples as 'wet' or not depending on specified thresholds. Wet and dry samples are differentiated on the map by their shapes.  Unlike `anlz_enteromap()`, the `yrsel` and `mosel` arguments are required. 

Additional information about a site can be seen by placing the cursor over a location.  A map inset can also be seen by clicking the arrow in the button left.

```{r}
show_enteromap(enterodata, yrsel = 2020, mosel = 9)
```


```{r}
# show whether a sample was 'wet' or not
show_enteromap(enterodata, yrsel = 2020, mosel = 9, wetdry = TRUE,
               temporal_window = 2, wet_threshold = 0.5)
```




`show_fibmatrix()` - **still need to discuss wet/dry subsetting option but how it's sort of squirrely for this context**


The `show_fibmatrix()` function creates a stoplight graphic of summarized FIB data at selected stations for each year of available data.  The function was primarily designed for fecal coliform data, but has been adapted to work with Enterococcus data as well.  The matrix color codes years and stations based on the likelihood of fecal indicator bacteria concentrations exceeding 400 CFU / 100 mL for Fecal Coliform (`fcolif` in `fibdata`) or 130 CFU / 100 mL for Enterococcus (`ecocci` in both `fibdata` and `enterodata`).   The likelihoods are categorized as A, B, C, D, or E (Microbial Water Quality Assessment or MWQA categories) with corresponding colors, where the breakpoints for each category are <10%, 10-30%, 30-50%, 50-75%, and >75% (right-closed). Methods and rationale for this categorization scheme are provided by the Florida Department of Environmental Protection, Figure 8 in @pbsj08 and @Morrison09.  

By default, the `show_fibmatrix()` function shows scores for fecal coliform. Enterococcus scores can be viewed by specifying `indic = 'ecocci'`.  

```{r, fig.height = 8, fig.width = 3}
# fibdata object
show_fibmatrix(fibdata, indic = 'ecocci')

# enterodata object
show_fibmatrix(enterodata, indic = 'ecocci')
```

By default, the results for each year are based on a right-centered window that uses the previous two years and the current year to calculate probabilities from the monthly samples (`lagyr = 3`).  This example shows results using only the monthly observations in each year. 

```{r, fig.height = 8, fig.width = 3}
show_fibmatrix(enterodata, indic = 'ecocci', lagyr = 1)
```

The default stations for fecal coliform scores are stations used in TBEP report #05-13 [@tbep0513] for the Hillsborough River Basin Management Action Plan (BMAP) subbasins.  For Enterococcus scores, the default is to use all stations in the provided data frame.  Other stations can be plotted using the `stas` argument.

```{r, fig.height = 8, fig.width = 1.5}
show_fibmatrix(enterodata, 
               indic = 'ecocci',
               stas = c('21FLHILL_WQX-101', '21FLHILL_WQX-102', '21FLHILL_WQX-103'))
```

The `yrrng` argument can also be used to select a year range, where the default is the date range contained in the data.  

```{r, fig.height = 8, fig.width = 3}
# fibdata object
show_fibmatrix(fibdata, indic = 'ecocci', yrrng = c(2015, 2020))

# enterodata object
show_fibmatrix(enterodata, indic = 'ecocci', yrrng = c(2015, 2020))
```

If preferred, the matrix can also be returned in an HTML table that can be sorted and scrolled. Only the first ten rows are shown by default.  The default number of rows (10) can be changed with the `nrows` argument.  Use a sufficiently large number to show all rows.

```{r}
show_fibmatrix(enterodata, indic = 'ecocci', 
               yrrng = c(2015, 2020), asreact = TRUE)
```

A plotly (interactive, dynamic plot) can be returned by setting the `plotly` argument to `TRUE`. 

```{r, fig.height = 8, fig.width = 3}
show_fibmatrix(enterodata, indic = 'ecocci', 
               yrrng = c(2015, 2020), plotly = TRUE)
```


